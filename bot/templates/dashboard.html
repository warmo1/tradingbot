<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Trading Bot Dashboard</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 2rem; }
    h1, h2, h3 { margin-bottom: 0.25rem; }
    .controls { display:flex; gap:1rem; align-items:center; margin-bottom: .5rem; }
  </style>
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
  <h1>Trading Dashboard</h1>
  
  <h2>Price Chart</h2>
  <div class="controls">
    <label>Symbol
      <select id="sym">
        <option>BTC/USDT</option>
        <option>ETH/USDT</option>
      </select>
    </label>
    <label>Timeframe
      <select id="tf">
        <option>1m</option>
        <option>15m</option>
        <option selected>1h</option>
        <option>4h</option>
        <option>1d</option>
      </select>
    </label>
    <button id="reload">Reload Chart</button>
  </div>
  <div id="priceChart" style="width: 100%; height: 350px;"></div>

  <h3>Uphold (Sandbox) Trade</h3>
  <form id="upholdForm" style="display:flex; gap:.5rem; align-items:center; margin:.75rem 0;">
    <input name="symbol" id="trade_symbol" value="BTC/USDT" style="width:8rem" readonly />
    <select name="side"><option value="buy">BUY</option></select>
    <input name="amount" type="number" step="0.01" min="1" value="10" style="width:8rem" />
    <input name="token" type="password" placeholder="admin token (optional)" style="width:10rem" />
    <button type="submit">Execute (Sandbox)</button>
  </form>
  <div id="tradeStatus"></div>

  <script>
    const chartElement = document.getElementById('priceChart');
    const chart = LightweightCharts.createChart(chartElement, { width: chartElement.clientWidth, height: 350 });
    const candleSeries = chart.addCandlestickSeries();

    async function loadChart() {
      const sym = document.getElementById('sym').value;
      const tf = document.getElementById('tf').value;
      document.getElementById('trade_symbol').value = sym;
      
      const response = await fetch(`/api/ohlcv?symbol=${encodeURIComponent(sym)}&timeframe=${encodeURIComponent(tf)}&limit=500`);
      const data = await response.json();
      
      if (data.rows && data.rows.length > 0) {
        candleSeries.setData(data.rows);
        chart.timeScale().fitContent();
      } else {
        console.log("No data received for the chart.");
        candleSeries.setData([]); // Clear the chart if no data
      }
    }

    document.getElementById('reload').addEventListener('click', loadChart);
    document.getElementById('sym').addEventListener('change', loadChart);
    document.getElementById('tf').addEventListener('change', loadChart);
    
    document.getElementById('upholdForm').addEventListener('submit', async function(event) {
        event.preventDefault();
        const statusDiv = document.getElementById('tradeStatus');
        statusDiv.innerText = "Submitting trade...";
        
        const formData = new FormData(this);
        const response = await fetch('/uphold_trade', { method: 'POST', body: formData });
        
        if (response.ok) {
            statusDiv.innerText = `Trade submitted successfully at ${new Date().toLocaleTimeString()}.`;
        } else {
            const errorText = await response.text();
            statusDiv.innerText = `Error: ${errorText}`;
        }
    });

    // Load the initial chart when the page loads
    loadChart();
  </script>
</body>
</html>
